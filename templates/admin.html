{% extends "base.html" %}

{% block content %}
    <h1>Admin Dashboard</h1>
    
    <h2>Users</h2>
    <table>
        <thead>
            <tr>
                <th>Username</th>
                <th>Admin Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>
                        <span class="admin-status" data-user-id="{{ user.id }}">
                            {% if user.is_admin %}Admin{% else %}User{% endif %}
                        </span>
                    </td>
                    <td>
                        <button class="toggle-admin" data-user-id="{{ user.id }}">
                            {% if user.is_admin %}Remove Admin{% else %}Make Admin{% endif %}
                        </button>
                        <button class="delete-user" data-user-id="{{ user.id }}">Delete User</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Projects</h2>
    <table>
        <thead>
            <tr>
                <th>Project Name</th>
                <th>Owner</th>
            </tr>
        </thead>
        <tbody>
            {% for project in projects %}
                <tr>
                    <td>{{ project.name }}</td>
                    <td>{{ project.author.username }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggleAdminButtons = document.querySelectorAll('.toggle-admin');
            const deleteUserButtons = document.querySelectorAll('.delete-user');

            toggleAdminButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const userId = button.dataset.userId;
                    fetch(`/admin/toggle_admin/${userId}`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const statusSpan = document.querySelector(`.admin-status[data-user-id="${userId}"]`);
                                statusSpan.textContent = data.is_admin ? 'Admin' : 'User';
                                button.textContent = data.is_admin ? 'Remove Admin' : 'Make Admin';
                            } else {
                                alert('Failed to update admin status');
                            }
                        });
                });
            });

            deleteUserButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (confirm('Are you sure you want to delete this user?')) {
                        const userId = button.dataset.userId;
                        fetch(`/admin/delete_user/${userId}`, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    button.closest('tr').remove();
                                } else {
                                    alert('Failed to delete user');
                                }
                            });
                    }
                });
            });
        });
    </script>
{% endblock %}
